---
title: "projeto_adm"
format: html
editor: visual
execute:
  warning: false
---

## PROJETO

Projeto ADM

Carregamento dos pacotes

```{r}
#| echo: true
#| output: false
#| error: false
#| label: libraries
# Libraries to use
library("dplyr")
# Check for missing packages and install them
cran_pkgs <- c("foreign", "dplyr", "tidyr", "ggplot2", "psych", "corrplot", "scales", "factoextra")
is_installed <- cran_pkgs %in% rownames(installed.packages())
if(any(is_installed == FALSE)){
  install.packages(cran_pkgs[!is_installed])
}
# Load packages
lapply(cran_pkgs, library, character.only = TRUE) 
```

Abrimos o ficheiro .rds e depois apenas selecionamos os dados que tem a coluna cntry igual a Portugal.

```{r}
filename <- "ESS10_parcial_ADM_all_countries.rds"
original <- readRDS(filename)
only_portugal <- original[original$cntry == "Portugal",]
```

Recodificamos as variáveis marsts e edulvlb

```{r}
tabela_recodificada <- only_portugal %>%
  mutate(
    # --- Estado Civil ---
    marsts = case_when(
      marsts %in% c("Legally married", 
                    "In a legally registered civil union") ~ "In relationship",
      marsts %in% c("Legally separated", 
                    "Legally divorced/Civil union dissolved", 
                    "Widowed/Civil partner died") ~ "Formerly in relationship",
      marsts == "None of these (NEVER married or in legally registered civil union)" ~ "Never in relationship",
      TRUE ~ NA_character_ 
    ),
    
    # --- Escolaridade ---
    edulvlb = case_when(
      edulvlb %in% c("Not completed ISCED level 1", 
                     "ISCED 1, completed primary education", 
                     "Vocational ISCED 2C < 2 years, no access ISCED 3", 
                     "General/pre-vocational ISCED 2A/2B, access ISCED 3 vocational", 
                     "General ISCED 2A, access ISCED 3A general/all 3", 
                     "Vocational ISCED 2C >= 2 years, no access ISCED 3", 
                     "Vocational ISCED 2A/2B, access ISCED 3 vocational", 
                     "Vocational ISCED 2, access ISCED 3 general/all") ~ "EduLevel:Low",
      
      edulvlb %in% c("Vocational ISCED 3C < 2 years, no access ISCED 5", 
                     "General ISCED 3 >=2 years, no access ISCED 5", 
                     "General ISCED 3A/3B, access ISCED 5B/lower tier 5A", 
                     "General ISCED 3A, access upper tier ISCED 5A/all 5", 
                     "Vocational ISCED 3C >= 2 years, no access ISCED 5", 
                     "Vocational ISCED 3A, access ISCED 5B/ lower tier 5A", 
                     "Vocational ISCED 3A, access upper tier ISCED 5A/all 5", 
                     "General ISCED 4A/4B, access ISCED 5B/lower tier 5A", 
                     "General ISCED 4A, access upper tier ISCED 5A/all 5", 
                     "ISCED 4 programmes without access ISCED 5", 
                     "Vocational ISCED 4A/4B, access ISCED 5B/lower tier 5A", 
                     "Vocational ISCED 4A, access upper tier ISCED 5A/all 5") ~ "EduLevel:Medium",
      
      edulvlb %in% c("ISCED 5A short, intermediate/academic/general tertiary below bachelor", 
                     "ISCED 5B short, advanced vocational qualifications", 
                     "ISCED 5A medium, bachelor/equivalent from lower tier tertiary", 
                     "ISCED 5A medium, bachelor/equivalent from upper/single tier tertiary", 
                     "ISCED 5A long, master/equivalent from lower tier tertiary", 
                     "ISCED 5A long, master/equivalent from upper/single tier tertiary", 
                     "ISCED 6, doctoral degree") ~ "EduLevel:High",
      TRUE ~ NA_character_
    )
  )

# Converter Variáveis para Tipos Corretos
# Fatores
tabela_recodificada$marsts <- 
  factor(tabela_recodificada$marsts, levels = c("In relationship", 
                                                "Formerly in relationship", 
                                                "Never in relationship"))
tabela_recodificada$edulvlb <- 
  factor(tabela_recodificada$edulvlb, levels = c("EduLevel:Low", 
                                                 "EduLevel:Medium", 
                                                 "EduLevel:High"))

tabela_recodificada$agea <- as.numeric(as.character(tabela_recodificada$agea))

```

## Parte 1 - Introdução e breve descrição dos inquiridos

Idade (agea)

```{r}
# Principais medidas de tendência central e dispersão
summary(tabela_recodificada$agea)
print(paste("Desvio Padrão:", sd(tabela_recodificada$agea, na.rm = TRUE)))

# Histograma
ggplot(tabela_recodificada, aes(x = agea)) +
  geom_histogram(binwidth = 5, fill = "#69b3a2", color = "white") +
  labs(title = "Distribuição de Idades", 
       x = "Idade", 
       y = "Frequência") +
  theme_minimal()
```

Género (gndr)

```{r}
# Tabela de frequências simples e percentagens
tabela_genero <- table(tabela_recodificada$gndr)
percentagens_genero <- prop.table(tabela_genero) * 100

# Juntar numa tabela legível
cbind(Frequencia = tabela_genero, Percentagem = round(percentagens_genero, 1))

```

Nível de escolaridade (edulvlb)

```{r}
# Filtramos os NAs para o gráfico ficar limpo
tabela_recodificada %>%
  filter(!is.na(edulvlb)) %>%
  ggplot(aes(x = edulvlb)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Nível de Escolaridade dos Respondentes", 
       x = "Nível de Escolaridade", 
       y = "Contagem") +
  theme_minimal()
```

Estado civil (marsts)

```{r}
# Passar os dados da coluna marsts para carateres porque se não dá erro
clean_marsts <- as.character(unlist(tabela_recodificada$marsts))

# Criamos um novo data frame
df_clean <- data.frame(marsts = clean_marsts, stringsAsFactors = FALSE)

pie_data <- df_clean %>%
  filter(!is.na(marsts)) %>%
  group_by(marsts) %>%
  summarise(n = n()) %>%
  mutate(
    prop = n / sum(n) * 100,
    ypos = cumsum(prop) - 0.5 * prop
  )

# Criar o gráfico setorial
ggplot(pie_data, aes(x = "", y = prop, fill = marsts)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  geom_text(aes(y = ypos, label = paste0(round(prop, 1), "%")), color = "white", size = 5) +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Estado Civil (Recodificado)",
       fill = "Situação")
```

## Parte 2 - Valores de Vida

Matriz de correlação

```{r}
tabela_numerica <- select(tabela_recodificada, BeCreative:SeekFun)

cor_matrix <- cor(tabela_numerica, use = "pairwise.complete.obs")

corrplot(
  cor_matrix,
  method = "color",
  type = "upper",
  diag = FALSE,
  tl.col = "black",
  tl.cex = 0.7,
  tl.srt = 45,
  addCoef.col = "black",
  number.cex = 0.55,
  col = colorRampPalette(c("steelblue", "white", "tomato"))(200),
  mar = c(0, 0, 3, 0)
)
title(main = "Correlation Matrix – Values", line = 1)
```

KMO

```{r}
KMO(tabela_numerica)
```

Teste de esfericidade de Bartlett

```{r}
cortest.bartlett(cor_matrix, n = nrow(tabela_numerica))
```

Análise de todos os valores próprios da matriz de correlação

```{r}
fviz_eig(princomp(cor_matrix,cor=TRUE), addlabels = TRUE, ylim = c(0, 50))
# Para ver os valores exatos dos Eigenvalues:
eigen(cor_matrix)$values
```

Modelo sem rotação

```{r}
pca_resultado <- principal(tabela_numerica, nfactors = 4, rotate = "varimax")

print(pca_resultado$loadings, cutoff = 0.3, sort = TRUE)
```

## Parte 3 - Estarão os valores de vida relacionados com a escolaridade?

Criamos um novo data frame para ser mais fácil trabalhar com os dados obtidos acima com a ACP

```{r}
# 1. Transformar os resultados da PCA num data frame
scores <- data.frame(pca_resultado$scores)

# 2. Dar nomes às colunas para facilitar (Baseado na tua ordem: RC1, RC2, RC3, RC4)
colnames(scores) <- c("Altruismo", "Hedonismo", "Conservadorismo", "Seguranca")

# 3. Juntar tudo numa nova tabela para o exercício 3
dados_final <- cbind(tabela_recodificada, scores)
```

```{r}
# PREPARAÇÃO DOS DADOS
scores <- data.frame(pca_resultado$scores)
colnames(scores) <- c("Altruismo", "Hedonismo", "Conservadorismo", "Seguranca")
dados_final <- cbind(tabela_recodificada, scores)
# -----------------------------------------------------------------------------
# 1. ALTRUÍSMO
# -----------------------------------------------------------------------------
modelo1 <- aov(Altruismo ~ edulvlb, data = dados_final)
summary(modelo1)
TukeyHSD(modelo1)
ggplot(dados_final, aes(x = edulvlb, y = Altruismo, fill = edulvlb)) + geom_boxplot()

# -----------------------------------------------------------------------------
# 2. HEDONISMO
# -----------------------------------------------------------------------------
modelo2 <- aov(Hedonismo ~ edulvlb, data = dados_final)
summary(modelo2)
TukeyHSD(modelo2)
ggplot(dados_final, aes(x = edulvlb, y = Hedonismo, fill = edulvlb)) + geom_boxplot()

# -----------------------------------------------------------------------------
# 3. CONSERVADORISMO
# -----------------------------------------------------------------------------
modelo3 <- aov(Conservadorismo ~ edulvlb, data = dados_final)
summary(modelo3)
TukeyHSD(modelo3)
ggplot(dados_final, aes(x = edulvlb, y = Conservadorismo, fill = edulvlb)) + geom_boxplot()

# -----------------------------------------------------------------------------
# 4. SEGURANÇA
# -----------------------------------------------------------------------------
modelo4 <- aov(Seguranca ~ edulvlb, data = dados_final)
summary(modelo4)
TukeyHSD(modelo4)
ggplot(dados_final, aes(x = edulvlb, y = Seguranca, fill = edulvlb)) + geom_boxplot()
```

## Parte 4 - Indicador de Confiança Instituicional

```{r}

library(dplyr)
library(psych)
library(corrplot)
library(factoextra)

# Selecionar variáveis de confiança institucional
dados_conf <- dados_final %>% 
  select(trstprl, trstlgl, trstplc, trstplt, trstprt, trstep, trstun) %>% 
  drop_na()

# Matriz de correlação

cor_conf <- cor(dados_conf)

corrplot(
  cor_conf,
  method = "color",
  type = "upper",
  diag = FALSE,
  tl.col = "black"
)

# Teste KMO
KMO(dados_conf)

# Teste de Bartlett

cortest.bartlett(cor_conf, n = nrow(dados_conf))

# Scree plot

res_pca_grafico <- prcomp(dados_conf, scale. = TRUE)

fviz_eig(
  res_pca_grafico,
  addlabels = TRUE,
  ylim = c(0, 80)
)

# Análise em Componentes Principais (1 componente, sem rotação)

pca_conf <- principal(
  dados_conf,
  nfactors = 1,
  rotate = "none",
  scores = TRUE
)
print(pca_conf$loadings, cutoff = 0.3)

# Variância explicada

pca_conf$Vaccounted

# Criar o Indicador de Confiança Institucional

dados_final$Confianca_Inst <- predict(
  pca_conf,
  dados_final %>% select(trstprl:trstun)
)[,1]

summary(dados_final$Confianca_Inst)
```

## Parte 5 - Será a Confiança Institucional influenciada pelo nível de escolaridade e pelo género?

```{r}
# Usamos o símbolo '*' para testar efeitos principais e a interação
modelo_confianca <- aov(Confianca_Inst ~ edulvlb * gndr, data = dados_final)

# 2. Validação de Pressupostos
# A. Homogeneidade de Variâncias (Teste de Levene)
library(car)
levene_result <- leveneTest(Confianca_Inst ~ edulvlb * gndr, data = dados_final)
print(levene_result)

# B. Normalidade dos Resíduos (Análise Gráfica)
plot(modelo_confianca, which = 2) # Q-Q Plot

# 3. Resultados da ANOVA
summary(modelo_confianca)

# 4. Testes Post-Hoc (Tukey) 
# Apenas interpretamos se houver resultados significativos (p < 0.05)
TukeyHSD(modelo_confianca)

# 5. Visualização Gráfica (Gráfico de Interação)
ggplot(dados_final %>% filter(!is.na(edulvlb), !is.na(gndr)), 
       aes(x = edulvlb, y = Confianca_Inst, color = gndr, group = gndr)) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun = mean, geom = "line") +
  labs(title = "Confiança Institucional por Escolaridade e Género",
       subtitle = "Análise de Interação",
       x = "Nível de Escolaridade",
       y = "Score de Confiança (Médias)") +
  theme_minimal()
```

## Parte 6 - A felicidade depende dos valores?

```{r}

# 1. Preparação
dados_limpos <- dados_final %>%
  filter(!is.na(happy), !is.na(agea), !is.na(gndr), !is.na(marsts)) %>%
  mutate(happy = as.numeric(as.character(happy)))

# 2. Modelo 1: Apenas Valores
modelo1_feli <- lm(happy ~ Altruismo + Hedonismo + Conservadorismo + Seguranca, 
                   data = dados_limpos)

# 3. Modelo 2: Valores + Demográficas (Idade, Género, Estado Civil)
modelo2_feli <- lm(happy ~ Altruismo + Hedonismo + Conservadorismo + Seguranca + 
                   agea + gndr + marsts, 
                   data = dados_limpos)

# 4. Agora o ANOVA e o SUMMARY já vão funcionar sem erros
summary(modelo2_feli)
anova(modelo1_feli, modelo2_feli)

# 5. Validação de Pressupostos
par(mfrow = c(2, 2))
plot(modelo2_feli)
```

## Parte 7 - Existem padrões nos valores?(Análise de clusters)

```{r}
# 1. Selecionar as variáveis de agrupamento (os scores da ACP) e remover NAs
dados_clusters <- dados_final %>%
  select(Altruismo, Hedonismo, Conservadorismo, Seguranca, 
         agea, gndr, edulvlb, marsts) %>%
  na.omit()

# 2. Determinar o número ideal de clusters (Método de Elbow)
fviz_nbclust(dados_clusters[,1:4], kmeans, method = "wss") +
  labs(title = "Método de Elbow para Seleção de Clusters")

# 3. Executar o K-means
set.seed(123) # Para resultados reproduzíveis
k_resultado <- kmeans(dados_clusters[,1:4], centers = 3, nstart = 25)

# 4. Adicionar o cluster ao dataset
dados_clusters$cluster <- as.factor(k_resultado$cluster)

# 5. Caraterização dos Grupos (Médias dos Valores)
aggregate(dados_clusters[,1:4], by=list(cluster=dados_clusters$cluster), mean)

# 6. Caraterização Sociodemográfica (Cruzamentos)
# Idade média por cluster
aggregate(agea ~ cluster, data = dados_clusters, mean)

# Distribuição de Escolaridade por cluster
table(dados_clusters$cluster, dados_clusters$edulvlb) %>% prop.table(margin = 1) * 100

# Visualização dos Clusters
fviz_cluster(k_resultado, data = dados_clusters[,1:4], geom = "point", 
             ellipse.type = "convex", main = "Perfis de Valores em Portugal")
```
